version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Environment info
        - echo "Node version $(node --version)"
        - echo "NPM version $(npm --version)"
        - echo "Current directory $(pwd)"
        
        # Debug package.json
        - echo "Checking package dependencies..."
        - node -e "console.log('Package dependencies:', JSON.stringify(require('./package.json').dependencies, null, 2))"
        
        # List directory contents for debugging
        - echo "Directory contents:"
        - ls -la
        
        # Clean and verify npm cache
        - echo "Cleaning npm cache..."
        - npm cache clean --force
        - npm cache verify
        
        # Install dependencies with error handling
        - echo "Installing dependencies..."
        - npm install || (echo "npm install failed" && exit 1)
        
        # Install specific dependencies with error handling
        - echo "Installing specific dependencies..."
        - |
          npm install --save \
            lucide-react@0.263.1 \
            react-oidc-context@3.2.0 \
            @babel/plugin-proposal-private-property-in-object@7.21.11 \
            jspdf@2.5.1 \
            html2canvas@1.4.1 \
            clsx@2.1.0 \
            class-variance-authority@0.7.0 \
            @aws-amplify/auth@6.8.0 \
            @aws-amplify/ui-react@6.7.0 \
            aws-amplify@6.0.0 \
            @radix-ui/react-alert-dialog@1.1.3 \
            @radix-ui/react-select@2.1.3 \
            @radix-ui/react-slot@1.1.1 \
            tailwind-merge@2.2.0 \
            @stripe/react-stripe-js@3.0.0 \
            @stripe/stripe-js@5.2.0 || (echo "Specific dependencies installation failed" && exit 1)
        
        # Install global dependencies
        - npm install -g react-scripts
        
        # Install backend dependencies
        - echo "Installing backend dependencies..."
        - cd backend && npm install || (echo "Backend dependencies installation failed" && exit 1)
        - cd ..
        
        # Verify installations
        - echo "Verifying installations..."
        - npm list react-oidc-context || true
        - npm list lucide-react || true

    build:
      commands:
        # Build frontend with error catching
        - echo "Building frontend for testing environment..."
        - |
          GENERATE_SOURCEMAP=false CI=false npm run build:testing || (
            echo "Frontend build failed"
            echo "Checking for common build issues..."
            npm list
            exit 1
          )
        
        # Build backend with error catching
        - echo "Building backend..."
        - cd backend
        - mkdir -p dist
        - |
          npm run build || (
            echo "Backend build failed"
            exit 1
          )
        - cd ..
        
        # Verify build outputs
        - echo "Verifying build outputs..."
        - ls -la build/
        - echo "Verifying backend build..."
        - ls -la backend/dist/

  artifacts:
    baseDirectory: build
    files:
      - '**/*'
      - 'backend/dist/**/*'
    
  cache:
    paths:
      - node_modules/**/*
      - backend/node_modules/**/*
      - /root/.npm/**/*
      
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000'
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'SAMEORIGIN'
        - key: 'X-XSS-Protection'
          value: '1; mode=block'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'
    - pattern: '*.html'
      headers:
        - key: 'Cache-Control'
          value: 'no-cache'
    - pattern: 'service-worker.js'
      headers:
        - key: 'Cache-Control'
          value: 'no-cache'