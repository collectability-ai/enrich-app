version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Node version $(node --version)"
        - echo "NPM version $(npm --version)"
        - echo "Starting in directory $(pwd)"
        - npm ci
    build:
      commands:
        - echo "Setting build environment..."
        - |
          cat << EOF > .env.production
          REACT_APP_ENVIRONMENT=$REACT_APP_ENVIRONMENT
          REACT_APP_API_BASE_URL=$REACT_APP_API_BASE_URL
          REACT_APP_AWS_REGION=$REACT_APP_AWS_REGION
          REACT_APP_USER_POOL_ID=$REACT_APP_USER_POOL_ID
          REACT_APP_USER_POOL_WEB_CLIENT_ID=$REACT_APP_USER_POOL_WEB_CLIENT_ID
          REACT_APP_IDENTITY_POOL_ID=$REACT_APP_IDENTITY_POOL_ID
          REACT_APP_AUTH_DOMAIN=$REACT_APP_AUTH_DOMAIN
          REACT_APP_REDIRECT_SIGN_IN=$REACT_APP_REDIRECT_SIGN_IN
          REACT_APP_REDIRECT_SIGN_OUT=$REACT_APP_REDIRECT_SIGN_OUT
          REACT_APP_COOKIE_DOMAIN=$REACT_APP_COOKIE_DOMAIN
          EOF
        - echo "Environment file created:"
        - cat .env.production
        - export CI=false
        - export GENERATE_SOURCEMAP=false
        - export NODE_OPTIONS="--max-old-space-size=8192"
        - echo "Starting build..."
        - npm run build
        - echo "Build complete. Checking output..."
        - ls -la build/
  artifacts:
    baseDirectory: build
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000'
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'