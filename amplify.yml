version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting preBuild phase"
        - cd frontend
        - npm ci
        - npm install -g react-scripts
        - echo "Environment Variables during preBuild:"
        - printenv | grep REACT_APP_ # Debug: Log REACT_APP_* variables
        - cd ../backend
        - npm ci
        - echo "Environment Variables during backend setup:"
        - printenv | grep REACT_APP_ # Debug: Log REACT_APP_* variables for backend
        - cd ../frontend
    build:
      commands:
        - echo "Building frontend"
        # Set FRONTEND_URL based on environment
        - |
          if [ "${ENVIRONMENT}" = "testing" ]; then
            echo "FRONTEND_URL=https://testing.contactvalidate.com" >> .env.testing
            CI=false npm run build:testing
          else
            echo "FRONTEND_URL=https://app.contactvalidate.com" >> .env.production
            CI=false npm run build:production
          fi
        - echo "Frontend build completed"
        - echo "Environment Variables after frontend build:"
        - printenv | grep REACT_APP_ # Debug: Verify REACT_APP_* variables after frontend build
        # Export FRONTEND_URL for backend use
        - |
          if [ "${ENVIRONMENT}" = "testing" ]; then
            echo "export FRONTEND_URL=https://testing.contactvalidate.com" >> ../backend/dist/.env
          else
            echo "export FRONTEND_URL=https://app.contactvalidate.com" >> ../backend/dist/.env
          fi
        - cd ../backend
        - echo "Building backend"
        - mkdir -p dist
        - cp server.js server-config.js package.json dist/
        - cd dist && npm install --omit=dev
        - echo "Backend build completed"
  artifacts:
    baseDirectory: frontend/build
    files:
      - '**/*'
      - '../backend/dist/**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
      - backend/node_modules/**/*
      - /root/.npm/**/*
  customRules:
    - source: '/api/*'
      target: '/backend/dist/server.js'
      status: '200'
    - source: '/*'
      target: '/index.html'
      status: '200'
